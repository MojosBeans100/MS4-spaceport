{% extends 'index.html' %}
{% load static %}

{% block title %}
<title></title>
{% endblock title %}

{% block content %}

<div id="detail-view-container" class="container-fluid" style="overflow:hidden;">

    {% if user.is_authenticated %}

    <div class="container" id="detail-links">
        <div class="row">
            <p class="w-lg-50"><small>Pipelines are not updated automatically: press <strong>Update</strong> to
                    refresh the pipeline</small></p>
            <div class="col-md-6 py-2">
                <a href="{% url 'my_pipelines' %}"><button type="button" class="btn btn-dark"><i
                            class="fas fa-arrow-left"></i>My pipelines</button></a>
            </div>
            <div class="col-md-6 py-2">
                <a href="{% url 'update' pipeline.id %}"><button type="button" class="btn btn-dark"><i
                            class="fas fa-sync"></i>Update</button></a>
                {% if error %}
                <p>Your pipeline could not be updated</p>
                {{error}}
                {% else %}
                {% if pipeline.results_updated is None %}
                <p><strong>Pipeline pending:<br> update to see results</strong></p>
                {% else %}
                <p><small>last updated: {{pipeline.results_updated}}</small></p>
                {% endif %}
                {% endif %}
            </div>
            <!-- <div class="col-md-4 py-2">
                <a href="{% url 'edit_pipeline' pipeline.id %}"><button type="button" class="btn btn-dark"><i
                            class="fas fa-edit"></i>Edit</button></a>
            </div> -->
        </div>
    </div>

    <div id="detail-view-div">

        <!-- pipeline general info section -->
        <div class="detail-view-section">


            {% if pipeline.status == 'pending' %}
            <div class="d-flex justify-content-center">
                <div class="col col-md-6 col-xl-9" id="pending-section"
                    style="text-align: center; color: orange; padding: 30px 40px;">
                    <h4>Pipelines can take a few minutes to set up. We recommend to allow 5 minutes for us to
                        search our database for your results.<br>
                        Click the Update button at the top of the page to see if we have finished updating your
                        pipeline.<br> Thank you for your patience, and we hope your pipeline is successful.</h4>
                </div>
            </div>
            {% else %}
            {% endif %}

            <!-- pipeline general info table -->
            <div>
                <h1>{{pipeline.pipeline_name}}</h1>
                <p>{{pipeline.pipeline_des}}</p>
            </div>

            <!-- put map here -->
            <div id="detail_map"></div>
            <br>
            <br>

            <!-- pipeline general info table -->
            <div>
                <table id="detail-table">
                    <tr>
                        <td>Status:</td>
                        <td>{{pipeline.status}}</td>
                    </tr>
                    <tr>
                        <td>Date created:</td>
                        <td>{{pipeline.date_created}}</td>
                    </tr>
                </table>


            </div>
        </div>

        <hr>

        <!-- pipeline interval section -->
        <div class="detail-view-section">

            <div>
                <h3>Intervals</h3>

                <p>From {{pipeline.start_date|date:'d M Y'}} to {{pipeline.end_date|date:'d M Y'}}</p>

                {% if pipeline.status == 'pending' %}
                <p>Update the pipeline to see interval information</p>
                {% else %}

                <div class="detail-view-section">
                    <canvas id="myChart" width="800" height="200"></canvas>
                </div>

                <br>
                <br>
                <div class="table-responsive">
                    <table class="table" id="interval-table">
                        <tr>
                            <th>Start date</th>
                            <th>End date</th>
                            <th>Status</th>
                        </tr>

                        {% for result in results %}
                        <tr>
                            <td>{{result.interval_start_date|date:'d M'}}</td>
                            <td>{{result.interval_end_date|date:'d M'}}</td>
                            <td>{{result.status}}</td>
                        </tr>
                        {% endfor %}
                    </table>

                    <!-- interval status table -->
                    <div>
                        <table id="detail-table">
                            <tr>
                                <td>Current interval:</td>
                                <td></td>
                            </tr>
                            <tr>
                                <td>Next interval:</td>
                                <td></td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% endif %}


            </div>

        </div>

        <hr>

        <!-- pipeline results section -->
        <div class="detail-view-section">
            <h3>Results</h3>
            {% if pipeline.status == 'pending' %}
            <p>Update the pipeline to see results information</p>
            {% else %}
            <div class="table-responsive">
                <table class="table" id="result-table">
                    <tr data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true"
                        aria-controls="collapseOne">
                        <th>Expand all <i class="fas fa-angle-down"></i></th>
                        <th>Status</th>
                        <th>Interval dates</th>
                        <th>Image Preview</th>
                        <th>Image Captured</th>
                        <th>Image Source</th>
                        <th>Metadata</th>
                    </tr>

                    {% for result in results %}

                    <!-- if an image has been found for the result object -->
                    <!-- display the image preview and image data -->
                    {% if result.image_visual_url %}
                    <tr>
                        <td></td>
                        <td>{{result.status}}</td>
                        <td>{{result.interval_start_date|date:'d M'}} <br>to {{result.interval_end_date|date:'d M'}}
                        </td>
                        <td><a href="{{result.image_visual_url}}" target="_blank" download><img
                                    style="height: 50px; width: 50px" src="{{result.image_visual_url}}"></a></td>
                        <td>{{result.image_created_at}}</td>
                        <td>{{result.image_source}}</td>
                        <td><a href="{{result.image_metadata_url}}" target="_blank"><i
                                    class="fas fa-external-link-alt"></i></a></td>
                    </tr>

                    <tr id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                        data-bs-parent="#accordionExample">
                        <td colspan="7">
                            <div class="row d-flex justify-content-evenly">
                                <div class="col-3">
                                    <table>

                                        <tr>
                                            <td>Scene height</td>
                                            {% if result.scene_height is None %}
                                            <td>-</td>
                                            {% else %}
                                            <td>{{result.scene_height}} km</td>
                                            {% endif %}
                                        </tr>

                                        <tr>
                                            <td>Scene width</td>
                                            {% if result.scene_width is None %}
                                            <td>-</td>
                                            {% else %}
                                            <td>{{result.scene_width}} km</td>
                                            {% endif %}
                                        </tr>

                                        <tr>
                                            <td>Cloud cover</td>
                                            {% if result.cloud_cover_per is None %}
                                            <td>-</td>
                                            {% else %}
                                            <td>{{result.cloud_cover_per}} %</td>
                                            {% endif %}
                                        </tr>

                                    </table>
                                </div>

                                <div class="col-3">
                                    <table>
                                        <tr>
                                            <td>AOI area coverage</td>
                                            {% if result.aoi_area_per is None %}
                                            <td>-</td>
                                            {% else %}
                                            <td>{{result.aoi_area_per}} %</td>
                                            {% endif %}
                                        </tr>

                                        <tr>
                                            <td>Visible area</td>
                                            {% if result.visible_area is None %}
                                            <td>-</td>
                                            {% else %}
                                            <td>{{result.visible_area}} km <sup>2</sup></td>
                                            {% endif %}
                                        </tr>

                                        <tr>
                                            <td>Visible area %</td>
                                            {% if result.aoi_visible_area_per is None %}
                                            <td>-</td>
                                            {% else %}
                                            <td>{{result.aoi_visible_area_per}} %</td>
                                            {% endif %}
                                        </tr>

                                        <tr>
                                            <td>Filled area</td>
                                            {% if result.filled_area is None %}
                                            <td>-</td>
                                            {% else %}
                                            <td>{{result.filled_area}} km <sup>2</sup></td>
                                            {% endif %}
                                        </tr>

                                    </table>
                                </div>

                                <div class="col-3">
                                    <table>
                                        <tr>
                                            <td><a href="{{result.image_analytics_url}}" target="_blank">Download
                                                    image <i class="fas fa-download"></i></a></td>
                                        </tr>

                                        <tr>
                                            <td>Image size: {{result.image_size}} (MB)</td>
                                        </tr>

                                    </table>
                                </div>
                            </div>
                        </td>
                    </tr>

                    <!-- if there is no image found (yet) -->
                    {% else %}
                    <tr>
                        <td></td>
                        <td>{{result.message}}</td>
                        <td>{{result.interval_start_date|date:'d M'}} <br>to {{result.interval_end_date|date:'d M'}}
                        </td>

                        <!-- if the result status is future, there may be a result in the future
                    so set to pending -->
                        {% if result.status == 'future' %}
                        <td><em>pending</em></td>

                        <!-- but if the interval is complete -->
                        {% else %}
                        <td><em>No image found</em></td>
                        {% endif %}
                        <td style="text-align: center;">-</td>
                        <td style="text-align: center;">-</td>
                        <td style="text-align: center;">-</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </table>
            </div>
            {% endif %}
        </div>

        <hr>

        <!-- pipeline parameters section -->
        <div class="detail-view-section">
            <h3>Parameters</h3>
            {% if pipeline.status == 'pending' %}
            <p>Update the pipeline to see parameters information</p>
            {% else %}

            <div class="parameters-section">
                <h5>AOI</h5>
                <div class="table-responsive">
                    <table class="table" id="aoi-table">
                        <tr>
                            <th>Parameter</th>
                            <th>Value</th>
                        </tr>

                        <tr>
                            <td>geoJSON</td>
                            <td><textarea disabled>{{pipeline.aoi}}</textarea></td>
                        </tr>

                        <tr>
                            <td>Area</td>
                            <td>{{pipeline.aoi_area}} km<sup>2</sup></td>
                        </tr>

                        <tr>
                            <td>Max cloud cover %</td>
                            <td>{{pipeline.cloud_cover}}%</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="parameters-section">
                <h5>Output</h5>

                <p>Image type: {{pipeline.get_output_image_display}}</p>

            </div>
            {% endif %}

        </div>

        <hr>

        <!-- pipeline edit/update/delete section -->
        <div class="detail-view-section">
            <h3>Edit</h3>
            {% if pipeline.time_edited %}
            <p>Last edited: {{pipeline.time_edited}}</p>
            {% else %}
            {% endif %}

            {% if pipeline.status == 'pending' %}
            <p>Pipelines cannot be edited or deleted when the status is "Pending".</p>
            {% elif pipeline.status == 'complete' %}
            <p>Pipeline is completed, it can no longer be edited.</p>
            <div class="d-flex justify-content-center">
                <div class="px-5"><a href="{% url 'delete_view' pipeline.id %}"><button class="btn btn-dark"><i
                                class="far fa-trash-alt"></i>Delete pipeline</button></a></div>
            </div>
            {% else %}
            <p>Pipelines can be edited and deleted using the links below.</p>
            <div class="row d-flex justify-content-evenly" id="detail-edit-buttons">
                <div class=" py-2"><a href="{% url 'edit_pipeline' pipeline.id %}"><button class="btn btn-dark"><i
                                class="fas fa-edit"></i>Edit pipeline</button></a></div>
                <div class=" py-2"><a href="{% url 'delete_view' pipeline.id %}"><button class="btn btn-dark"><i
                                class="far fa-trash-alt"></i>Delete pipeline</button></a></div>
            </div>
            {% endif %}

        </div>

    </div>
    {% else %}
    <p>Ooops.. you have been directed to the wrong page. <a href="{% url 'homepage' %}">Return to home</a></p>
    {% endif %}

</div>

{{ pipeline.aoi|json_script:"map_aoi" }}
{{images}}

<script>
    detailMap();

    function detailMap() {

        var mapbox_key = "{{ mapbox_key | safe}}";
        var aoi = JSON.parse(document.getElementById('map_aoi').textContent);
        var map_aoi = aoi["features"][0]['geometry'];

        var lat = aoi['features'][0]['geometry']['coordinates'][0][0][1];
        var long = aoi['features'][0]['geometry']['coordinates'][0][0][0];

        displayAOI();

        /* external library - Mapbox */
        function displayAOI() {
            mapboxgl.accessToken =
                mapbox_key;
            const map = new mapboxgl.Map({
                container: 'detail_map',
                style: 'mapbox://styles/mapbox/light-v10',
                center: [long, lat],
                zoom: 10,
            });

            map.on('load', () => {

                map.addSource('display_aoi', {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'geometry': map_aoi,

                    }
                });


                map.addLayer({
                    'id': 'display_aoi',
                    'type': 'fill',
                    'source': 'display_aoi',
                    'layout': {},
                    'paint': {
                        'fill-color': '#0080ff',
                        'fill-opacity': 0.5
                    }
                });

                map.addLayer({
                    'id': 'outline',
                    'type': 'line',
                    'source': 'display_aoi',
                    'layout': {},
                    'paint': {
                        'line-color': '#000',
                        'line-width': 3
                    }
                });
            });
        }
    }
    /* external library end  */

    function timelineChart() {
        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                datasets: [{
                    label: '# of Votes',
                    data: [12, 19, 3, 5, 2, 3],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>




{% endblock content %}