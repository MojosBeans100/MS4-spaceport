{% extends 'index.html' %}
{% load static %}

{% block title %}
<title>Create a pipeline</title>
{% endblock title %}

{% block content %}



<body id="create_container">
    <div class="container-fluid">
        {% if user.is_authenticated %}
        <form action="" method="POST" id="create_form">
            {% csrf_token%}

            <!-- start of form section -->
            <div id="start_form_section" style="height: 70vh; overflow: auto;" class="tab">

                {% if error %}
                <div style="padding-top: 100px; border: solid black; width: 50%; margin-left: 25%;">
                    <h2 style="text-align: center">{{error}}</h2>
                </div>
                {% else %}
                {% endif %}

                <h2>Create a pipeline</h2>
                <h4>Use this form to create your pipeline and start collecting satellite imagery</h4>
                <p style="text-align: center; text-decoration: none; color: black;">If this is your first pipeline, we
                    recommend exploring our <a href="discover.html"><strong>'Discover'</strong></a> page first</p>
                <div class="d-flex justify-content-center">
                    <div id="start-form-div" class="col col-lg-9 col-xxl-9">
                        <div class="input-sections">
                            <h5>Restrictions:</h5>
                            <h6>This service is free, therefore there are some strict parameter limits.</h6>
                            <ul>
                                <li>- The Area of Interest (AOI) must be more than 25 km<sup>2</sup>, and no more than
                                    100
                                    km<sup>2</sup></li>
                                <li>- Only images with a minimum of 50% AOI coverage will be delivered</li>
                                <li>- Pipelines can have no more than 10 intervals</li>
                                <li>- Resolution is limited to 8 to 15 metres</li>
                                <li>- Only images taken within the last 3 years (since 2020) are available</li>
                            </ul>
                        </div>

                        <div class="input-sections">
                            <h5>Maximum chance of satellite aquisition:</h5>
                            <h6>See our recommendations for the maximum chance of your pipeline delivering images</h6>
                            <ul>
                                <li>- Choose a larger AOI (up to 100 km<sup>2</sup>)<br><small>The larger the AOI, the
                                        more chance it falls within a satellite's trajectory</small></li>
                                <li>- Maximise the interval length<br><small>If the pipeline interval is a month, there
                                        is
                                        more
                                        chance
                                        a satellite is orbiting overhead at some point within those 30 days, than if the
                                        interval is
                                        set to 1 day</small></li>
                                <li>- Increase allowable cloud cover percentage<br><small>If cloud cover percentage is
                                        set to a low number, it will reject any images above this number. (This does not
                                        mean all images
                                        will be below the number set.)</small></li>
                            </ul>
                        </div>
                        <div class="input-sections">
                            <h5>Calculate Probability</h5>
                            <h6>We can calculate the probability of return of images on the pipeline parameters you
                                choose.
                            </h6>
                            <p>If the percentage probability is low, we will give you advice on how to increase it
                                before you commit your pipeline.</p>
                            <p>Probability calculation is only available for <strong>True Colour</strong> images.</p>
                        </div>

                        <div class="input-sections">
                            <h5>Selecting the AOI</h5>
                            <h6>Use the map to select an Area of Interest for your pipeline</h6>

                            <div class="row">
                                <div class="col-6 col-md-4" style="border: solid red;">
                                    <img style="width: 100%; height: 200px;" src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114686/aoi1_bjsn9n.jpg">
                                    <p>Click on the map to start drawing points to form a polygon</p>
                                </div>

                                <div class="col-6 col-md-4" style="border: solid red;">
                                    <img style="width: 100%; height: 200px;" src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114686/aoi2_owf6fa.jpg">
                                    <p>Use to toolbar to toggle between Selecting and Deleting</p>
                                </div>

                                <div class="col-6 col-md-4" style="border: solid red;">
                                    <img style="width: 100%; height: 200px;" src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114687/aoi3_nzuvlp.jpg">
                                    <p>Click on an individual point to delete it, by clicking the trash icon or delete on the keyboard</p>
                                </div>

                                <div class="col-6 col-md-4" style="border: solid red;">
                                    <img style="width: 100%; height: 200px;" src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114686/aoi4_g3syt0.jpg">
                                    <p>Any of the points can be dragged to change the shape of the polygon</p>
                                </div>

                                <div class="col-6 col-md-4" style="border: solid red;">
                                    <img style="width: 100%; height: 200px;" src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114686/aoi6_vk2qdp.jpg">
                                    <p>The polygon can be picked up and moved</p>
                                </div>

                                <div class="col-6 col-md-4" style="border: solid red;">
                                    <img style="width: 100%; height: 200px;" src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643115823/aoi7_ixbys4.jpg">
                                    <p>You will receive feedback on the size of the area selected</p>
                                </div>
                            </div>

                        </div>

                        <div class="input-sections">
                            <h5>Pipeline Ideas</h5>
                            <h6>Not sure how to begin?  Here are some ideas to get you started..</h6>

                            <ul>
                                <li>Select an AOI of the area you used to live in, to see if the landscape has changed
                                </li>
                                <li>See if you can collect images from the Tonga volcano eruption on the 14<sup>th</sup>
                                    January 2022</li>
                                <li>Track Hurricane Ida in Louisiana, USA from August to September 2021</li>
                            </ul>

                        </div>
                    </div>
                </div>
            </div>

            <!-- general form section -->
            <div id="general_form_section" class="tab">
                <div class="row">

                    <div class="col">
                        <div class="form_title">
                            <h4>General</h4>
                            <br>
                            <p>Provide some general details to identify your pipeline</p>
                        </div>
                    </div>

                    <!-- <div class="col  d-flex justify-content-end" style="border: solid red;">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div> -->
                </div>

                <div class="section_div">
                    <div class="input-sections" id="form_name_div">
                        <label for="pipeline_name" class="form-label">Name</label>
                        {{form.pipeline_name}}
                    </div>

                    <div class="input-sections" id="form-des-div">
                        <label for="pipeline_des" class="form-label">Description</label>
                        {{form.pipeline_des}}
                    </div>
                </div>
            </div>

            <!-- aoi form section -->
            <div id="aoi_form_section" class="tab">
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Area of Interest</h4>
                            <br>
                            <p>Tell us where to look for images. <span class="form_limits">Area must be between 25 km<sup>2</sup> and 100 km<sup>2</sup></span></p>
                        </div>
                    </div>

                    <!-- <div class="col d-flex justify-content-end">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div> -->
                </div>

                <div id="map-feedback">
                    <p id="map-area">Area: 0 km<sup>2</sup></p>
                </div>

                <div id="create-map"></div>

                <div class="input-sections">
                    {{form.aoi}}
                </div>

                <!-- <div class="input-sections">
                    <label for="aoi_area" class="form-label">Minimum coverage of the AOI</label>
                    <p><small>Minimum coverage area (%) of the AOI your result must have<br>
                            i.e. if the selected AOI is 50 km<sup>2</sup> with 50% AOI coverage, only images with 25
                            km<sup>2</sup> AOI coverage will be returned <br>
                            Enter a number between 1 and 100</small></p>
                    {{form.aoi_area}}
                </div> -->


            </div>

            <!-- interval form section -->
            <div id="interval_form_section" class="tab">
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Interval</h4>
                            <br>
                            <p>Select the start and end date of this pipeline and how frequently to search for images
                                <br>
                                The pipeline will aim to deliver one image between each interval start and end date</p>
                            <p>Intervals in the past will search for archived imagery and, if available, deliver them
                                straight away.<br>Future intervals will be set up to deliver images as soon as an image
                                in that interval is found.</p>
                            <p class="form_limits">Pipelines can have no more than 10 intervals</p>
                        </div>
                    </div>

                    <!-- <div class="col d-flex justify-content-end">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div> -->
                </div>

                <div class="row">
                    <div class="col col-md-4" id="s_date">
                        <label for="start_date" class="form-label">from</label>
                        {{form.start_date}}
                    </div>

                    <div class="col col-md-4" id="e_date">
                        <label for="end_date" class="form-label">to</label>
                        {{form.end_date}}
                    </div>
                </div>

                <div class="input-sections w-25">
                    <label for="interval" class="form-label">Interval</label>
                    {{form.interval}}
                </div>
            </div>

            <!-- parameters form section -->
            <div id="parameters_form_section" class="tab">
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Parameters</h4>
                        </div>
                    </div>

                    <div class="col d-flex justify-content-end">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div>
                </div>

                <div class="input-sections">
                    <label for="cloud_cover" class="form-label">Cloud cover</label>
                    <p><small>Minimum cloud free area (%) your result must have<br>Enter a number between 1 and
                            100</small></p>
                    {{form.cloud_cover}}
                </div>

                <div class="input-sections" id="cloud-cover">
                    <div class="row">
                        <div class="col-sm-4 p-3">
                            <img
                                src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642782571/30-per-cloud-cover_vfgigm.jpg">
                            <br>
                            <p><strong>Low cloud cover</strong></p>
                            <p>High AOI coverage</p>
                            <p>Lower probability of image return</p>
                        </div>

                        <div class="col-sm-4 p-3">
                            <img
                                src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642782570/65-per-cloud-cover_ufppk0.jpg">
                            <br>
                            <p><strong>Medium cloud cover</strong></p>
                            <p>Medium AOI coverage</p>
                            <p>Medium probability of image return</p>
                        </div>

                        <div class="col-sm-4 p-3">
                            <img
                                src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642782571/80-per-cloud-cover_j3wok7.jpg">
                            <br>
                            <p><strong>High cloud cover</strong></p>
                            <p>Low AOI coverage</p>
                            <p>Higher probability of image return</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- output image form section -->
            <div id="output_form_section" class="tab">
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Output Type</h4>
                            <br>
                            <p>Select the desired output image type</p>
                            <p class="form_limits">Only choosing a <em>True Color</em> image will allow for calculation
                                of
                                aquisition probability</p>
                        </div>
                    </div>

                    <!-- <div class="col d-flex justify-content-end">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div> -->
                </div>

                <div class="row input-sections">
                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">True Colour</p>
                            {{form.output_image.1.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642749757/true-colour_b02a5f.jpg">
                                <div class="image-des">
                                    <p>"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                                        incididunt ut labore"</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">False Colour Urban</p>
                            {{form.output_image.2.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642749875/false-colour-urban_mifri2.jpg">
                                <div class="image-des">
                                    <p>"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                                        incididunt ut labore"</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">False Colour Infrared</p>
                            {{form.output_image.3.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642749876/false-colour-infrared_vc3jjh.png">
                                <div class="image-des">
                                    <p>"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor
                                        incididunt ut labore"</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="row input-sections">
                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">All Optical Bands</p>
                            {{form.output_image.4.tag}}
                            <div class="image-parent">
                                <img class="image-image" src="../static/images/truecolourimg.jpg">
                                <div class="image-des">
                                    <p>"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                                        tempor
                                        incididunt ut labore"</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">MSAVI2</p>
                            {{form.output_image.5.tag}}
                            <div class="image-parent">
                                <img class="image-image" src="../static/images/truecolourimg.jpg">
                                <div class="image-des">
                                    <p>"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                                        tempor
                                        incididunt ut labore"</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">Near Infrared</p>
                            {{form.output_image.6.tag}}
                            <div class="image-parent">
                                <img class="image-image" src="../static/images/truecolourimg.jpg">
                                <div class="image-des">
                                    <p>"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod
                                        tempor
                                        incididunt ut labore"</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

            </div>

            <!-- review form section -->
            <div id="review_form_section" style="height: 70vh; overflow-y: auto;" class="tab">
                <div class="row">

                    <div class="col">
                        <div class="form_title">
                            <h4>Review</h4>
                            <br>
                            <p>Review the pipeline parameters and ensure they are correct before submitting</p>
                            <p class="form_limits">*parameters which can be changed after pipeline is committed</p>
                        </div>
                    </div>

                    <!-- <div class="col d-flex justify-content-end">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div> -->
                </div>

                <!-- feedback information from user's form -->
                <table id="feedback-table">
                    <tr>
                        <td class="table-section" colspan="2">General Information</td>
                    </tr>

                    <tr>
                        <td class="table-left">*Pipeline name:</td>
                        <td id="table-name" class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-left">*Description:</td>
                        <td id="table-des" class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-left">Status:</td>

                        <!-- change this -->
                        <td class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-section" colspan="2">Interval</td>
                    </tr>

                    <tr>
                        <td class="table-left">Starts:</td>
                        <td id="table-sdate" class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-left">Ends:</td>
                        <td id="table-edate" class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-left">Length:</td>
                        <td id="table-length" class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-left">Interval:</td>
                        <td id="table-interval" class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-left">Number of intervals:</td>
                        <td id="table-num-interval" class="table-right"></td>
                    </tr>

                    <tr>
                        <td class="table-section" colspan="2">Output</td>
                    </tr>

                    <tr>
                        <td class="table-left">Output:</td>
                        <td id="table-output" class="table-right"></td>
                    </tr>

                </table>

                <div id="review-aoi"></div>

                <table id="feedback-aoi">
                    <tr>
                        <td class="table-section" colspan="2">Area of Interest</td>
                    </tr>

                    <tr>
                        <td class="table-left">Area:</td>
                        <td class="table-right" id="table-area"></td>
                    </tr>

                    <tr>
                        <td class="table-left">geoJSON:</td>
                        <td class="table-right"><textarea id="table-geojson" rows="8" cols="15" disabled></textarea>
                        </td>
                    </tr>
                </table>

                <p>Once submitted, you will be redirected to your new pipeline.</p>
                <p>Processing pipelines can take a few minutes, so you will be encouraged to update the pipeline</p>


            </div>

            <div id="submitting_pipline" class="tab">
                <h1>Setting up your pipeline...</h1>
            </div>

            <!-- buttons and progress display section -->
            <div id="buttons-div">
                <div class="row align-items-center">
                    <div class="py-2 col-sm-4 order-sm-first d-flex justify-content-center justify-content-sm-start">
                        <button type="button" class="btn btn-dark" id="prevButton"
                            onclick="nextPrev(-1)">Previous</button>
                    </div>

                    <div class="py-2 order-last col-sm-4 d-flex justify-content-center">
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>

                    </div>

                    <div
                        class="py-2 order-first order-sm-last col-sm-4 d-flex justify-content-center justify-content-sm-end">
                        <button type="button" class="btn btn-dark" id="nextButton" onclick="nextPrev(1)">Next</button>
                    </div>
                </div>
            </div>

        </form>
        {% else %}
        <p style="margin-top: 150px;">You are not permitted to create a pipeline without being logged in.
            Sign up <a href="{% url 'account_login' %}">here</a>
        </p>
        {% endif %}
    </div>
</body>


<script>
    // library - https://www.w3schools.com/howto/howto_js_form_steps.asp
    // this step form uses code from the above link
    document.getElementById('id_output_1').checked = true;
    var currentTab = 0;
    showTab(currentTab)
    var interval;
    var mapbox_key = "{{ mapbox_key | safe}}";

    function validateDate() {

        // if feedback already exists, remove it
        if (document.getElementById('interval_feedback')) {
            document.getElementById('interval_feedback').remove()
        }

        if (document.getElementById('nextButton').disabled = true) {
            document.getElementById('nextButton').disabled = false;
        };

        // create new div to display interval feedback/validation
        interval_append = document.getElementById('interval_form_section');
        interval_feedback = document.createElement('div');
        interval_append.append(interval_feedback);
        interval_feedback.id = 'interval_feedback';

        // get user's dates input
        start_date = document.getElementById('start_date').value;
        end_date = document.getElementById('end_date').value;

        // get user's interval choice
        interval = document.getElementById('interval').value;
        interval_num = interval.slice(0, interval.length - 1);

        // parse into JS date format
        day1 = parseInt(start_date.slice(8, 10));
        day2 = parseInt(end_date.slice(8, 10));
        month1 = parseInt(start_date.slice(5, 7));
        month2 = parseInt(end_date.slice(5, 7));
        year1 = parseInt(start_date.slice(0, 4));
        year2 = parseInt(end_date.slice(0, 4));
        s_date = (month1 + '/' + day1 + '/' + year1);
        e_date = (month2 + '/' + day2 + '/' + year2);

        date1 = new Date(s_date);
        date2 = new Date(e_date);

        // calculate day difference
        var time_difference = date2.getTime() - date1.getTime();
        days_difference = Math.round(time_difference / (1000 * 60 * 60 * 24));
        num_intervals = days_difference / interval_num;
        num_intervals_rounded = Math.round(num_intervals)

        // display how many days the pipeline length is
        if (end_date && start_date && interval) {
            pipeline_length = document.createElement('p');
            pipeline_length.id = 'pipeline_length';
            pipeline_length.innerHTML = `Pipeline length: ${days_difference} days`;
            interval_feedback.append(pipeline_length);

            pipeline_intervals = document.createElement('p');
            pipeline_intervals.id = 'pipeline_intervals';
            pipeline_intervals.innerHTML =
                `Number of intervals: ${num_intervals_rounded}<br><small>This is an estimate but may change based on the layout of the intervals`;
            interval_feedback.append(pipeline_intervals);
        }

        // date error if start date is after end date
        if (end_date <= start_date && end_date) {
            date_error = document.createElement('p');
            date_error.innerHTML =
                "<small>The end date cannot be before the start date: <br> select a date after start date </small>";
            date_error.style.fontWeight = 'bold';
            interval_feedback.append(date_error);
            document.getElementById('nextButton').disabled = true;
        }



        // if num of intervals is more than 10 (API restriction for free data)
        if (num_intervals > 10 && end_date && start_date && interval) {
            interval_error = document.createElement('p');
            interval_error.innerHTML =
                "<small>Pipelines cannot have more than 10 intervals: <br> choose a large interval // decrease the pipeline length</small>";
            interval_feedback.append(interval_error);
            document.getElementById('nextButton').disabled = true;
        }

        // if interval is larger than pipeline
        if (interval_num > days_difference && end_date && start_date && interval) {
            interval_error = document.createElement('p');
            interval_error.innerHTML =
                '<small>The interval cannot be larger than the pipeline length: <br> choose a smaller interval // increase the pipeline length<small>';
            interval_error.style.fontWeight = 'bold';
            interval_feedback.append(interval_error);
            document.getElementById('nextButton').disabled = true;
        }

        // if date is too far in the past
        if (year1 < 2020 || year2 < 2020) {
            interval_error = document.createElement('p');
            interval_error.innerHTML =
                '<small>We cannot look for images before 2020: <br> choose a more recent date<small>';
            interval_error.style.fontWeight = 'bold';
            interval_feedback.append(interval_error);
            document.getElementById('nextButton').disabled = true;
        }

    }

    function styleOutputImage() {

        parent_checked = document.getElementsByClassName('output-label')

        for (i = 0; i < parent_checked.length; i++) {

            if (parent_checked[i].childNodes[3].checked) {
                console.log(parent_checked[i])
                parent_checked[i].style.fontWeight = 'bold';
                parent_checked[i].childNodes[5].style.opacity = '0.6';
            } else {
                parent_checked[i].style.fontWeight = 'normal';
                parent_checked[i].childNodes[5].style.opacity = '1';
            }
        }
    }

    function showTab(num) {
        var tab = document.getElementsByClassName('tab');
        tab[num].style.display = 'block';

        if (num == 0) {
            document.getElementById('prevButton').style.display = 'none';

        } else if (num == 1) {
            document.getElementById("prevButton").style.display = "inline";

        } else if (num == 2) {

            if (document.getElementById('id_aoi').value != "null") {

            } else {
                createMap();
            }

        } else if (num == 4) {

            reviewMap();

        } else if (num == 5) {

            styleOutputImage();

        } else if (num == 6) {

            createReview();

        } else if (num == 7) {
            document.getElementById("buttons-div").style.display = "none";
        }

        if (num == (tab.length - 2)) {
            document.getElementById('nextButton').innerHTML = "Submit";

        } else if (num == (tab.length - 3)) {
            document.getElementById('nextButton').innerHTML = "Review";

        } else {
            document.getElementById('nextButton').innerHTML = "Next";
        }

        fixStepIndicator(num)
    }

    function nextPrev(num) {

        var x = document.getElementsByClassName('tab');
        if (num == 1 && !validateForm()) return false;
        x[currentTab].style.display = 'none';
        currentTab = currentTab + num;

        if (x.length - currentTab == 1) {
            document.getElementById('create_form').submit();
            return false;
        }
        showTab(currentTab);
    }

    function fixStepIndicator(num) {

        var i, x = document.getElementsByClassName("step");
        for (i = 0; i < x.length - 1; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }

        x[num].className += " active";
    }

    function validateForm() {

        // This function deals with validation of the form fields
        var x, y, i, valid = true;
        x = document.getElementsByClassName("tab");
        y = x[currentTab].getElementsByTagName("input");
        // A loop that checks every input field in the current tab:
        for (i = 0; i < y.length; i++) {
            console.log(y[i])

            // If a field is empty...
            if (y[i].value == "") {
                // add an "invalid" class to the field:
                y[i].className += " invalid";
                // and set the current valid status to false:
                valid = false;
            }

            if (y[i].checked) {
                valid = true;
                //y[i].className +- " invalid";
            }

        }
        // If the valid status is true, mark the step as finished and valid:
        if (valid) {
            document.getElementsByClassName("step")[currentTab].className += " finish";
        }
        return valid; // return the valid status
    }

    function createMap() {

        if (document.getElementById('map-a')) {
            document.getElementById('map-a').remove()
        }

        input_validation = document.getElementById('id_aoi');

        // external library - https://docs.mapbox.com/mapbox-gl-js/example/mapbox-gl-draw/
        mapboxgl.accessToken = mapbox_key;
        const map = new mapboxgl.Map({
            container: 'create-map',
            style: 'mapbox://styles/mapbox/streets-v11',
            zoom: 4,
        });

        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true
            },
            defaultMode: 'draw_polygon'
        });
        map.addControl(draw);

        map.on('draw.create', updateArea);
        map.on('draw.delete', updateArea);
        map.on('draw.update', updateArea);

        aoi_section = document.getElementById('map-feedback')

        function updateArea(e) {

            input_validation = document.getElementById('id_aoi')

            map_area = document.getElementById('map-area')
            map_area.innerHTML = "Area: 0 km<sup>2</sup>"

            const data = draw.getAll();

            if (document.getElementById('area_validation_feedback')) {
                document.getElementById('area_validation_feedback').remove();
            }




            if (data.features.length > 0) {

                const area = turf.area(data);
                const rounded_area = Math.round(area * 100) / 100;
                rounded_km = (rounded_area / 1000000).toFixed(2);

                area_validation_feedback = document.createElement('p')
                area_validation_feedback.id = "area_validation_feedback"

                map_a = document.createElement('p');
                map_a.id = 'map-a';
                map_a.style.display = "none";
                map_a.innerHTML = rounded_km;
                aoi_section.append(map_a)

                if (rounded_km > 100) {

                    area_validation = "Area is too large: choose an area smaller than 100 km<sup>2</sup>";
                    area_validation_feedback.style.color = 'red';
                    input_validation.value = "";

                } else if (rounded_km < 25) {

                    area_validation = "Area is too small: choose an area larger than 25 km<sup>2</sup>";
                    area_validation_feedback.style.color = 'red';
                    input_validation.value = "";

                } else {

                    area_validation = "";
                    text = JSON.stringify(data);
                    input_validation.value = text;
                }

                map_area.innerHTML = `<p>Area: <strong>${rounded_km} km <sup>2</sup>`;
                area_validation_feedback.innerHTML = `${area_validation}`;
                aoi_section.append(area_validation_feedback);

            } else {
                answer.innerHTML = '';
                if (e.type !== 'draw.delete')
                    alert('Click the map to draw a polygon.');
            }
        }

        if (input_validation.value == 'null') {
            input_validation.value = "";
        }

    }

    function reviewMap() {

        aoi_json = JSON.parse(document.getElementById('id_aoi').value);
        aoi_map = aoi_json['features'][0]['geometry'];

        long = aoi_json['features'][0]['geometry']['coordinates'][0][0][0];
        lat = aoi_json['features'][0]['geometry']['coordinates'][0][0][1];

        mapboxgl.accessToken =
            mapbox_key;
        const map = new mapboxgl.Map({
            container: 'review-aoi',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [long, lat],
            zoom: 9,
        });

        map.on('load', () => {

            map.addSource('display_aoi', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'geometry': aoi_map,
                }
            });

            map.addLayer({
                'id': 'display_aoi',
                'type': 'fill',
                'source': 'display_aoi',
                'layout': {},
                'paint': {
                    'fill-color': '#0080ff',
                    'fill-opacity': 0.5
                }
            });

            map.addLayer({
                'id': 'outline',
                'type': 'line',
                'source': 'display_aoi',
                'layout': {},
                'paint': {
                    'line-color': '#000',
                    'line-width': 3
                }
            });
        });

    }

    function createReview() {

        reviewMap();

        // get table cells to fill in 
        table_feedback = document.getElementsByClassName('table-right');

        // get user's form inputs
        review_name = document.getElementById('pipeline_name').value;
        review_des = document.getElementById('pipeline_des').value;
        review_status = "Not yet committed";

        review_aoi = document.getElementById('id_aoi').value;

        review_sdate = document.getElementById('start_date').value;
        review_edate = document.getElementById('end_date').value;
        review_length = `${days_difference} days`;
        review_interval = interval;
        review_num_intervals = num_intervals_rounded;
        review_area = `${document.getElementById('map-a').innerHTML} km <sup>2</sup>`;

        radios = document.getElementsByName('output_image');
        radios_labels = document.getElementsByClassName('image-label');

        // determine which output image has been selected
        for (i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                review_output = radios_labels[i].innerText.trim();
                api_output = radios[i].value
            }
        }

        // render user's form inputs into the review table
        feedback = [review_name, review_des, review_status, review_sdate, review_edate, review_length, review_interval,
            review_num_intervals, review_output
        ];

        for (i = 0; i < feedback.length; i++) {
            table_feedback[i].innerHTML = feedback[i];
        }

        document.getElementById('table-area').append(review_area);

        document.getElementById('table-geojson').innerHTML = review_aoi;

    }
</script>

{% endblock content %}