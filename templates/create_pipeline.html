{% extends 'base.html' %}
{% load static %}

{% block title %}
<title>Create a pipeline</title>
{% endblock title %}

{% block content %}



<body id="create_container">
    <div class="container-fluid" style="padding-bottom: 50px;">
        {% if user.is_authenticated %}
        <form action="" method="POST" id="create_form">
            {% csrf_token%}

            <!-- start of form section -->
            <div id="start_form_section" style="margin-top: 50px; height: auto;" class="tab">

                {% if error %}
                <div style="padding-top: 100px; border: solid black; width: 50%; margin-left: 25%;">
                    <h2 style="text-align: center">{{error}}</h2>
                </div>
                {% else %}
                {% endif %}

                <h2>Create a Pipeline</h2>
                <br>

                <p style="text-align: center; text-decoration: none; color: black;">Use this form to create your
                    pipeline and start collecting satellite imagery</p>

                <p style="text-align: center; text-decoration: none; color: black;">If this is your first pipeline, we
                    recommend exploring our <a href="discover.html"><strong>'Discover'</strong></a> page first</p>

                <!-- create pipeline form sub navigation -->
                <div class="input-sections">
                    <div class="row">
                        <div class="col-12 py-1 text-center">
                            <a href="#how-it-works">How it works</a>
                        </div>
                        <div class="col-12 py-1 text-center">
                            <a href="#restrictions">Restrictions</a>
                        </div>
                        <div class="col-12 py-1 text-center">
                            <a href="#satellite-aquisition">Satellite Aquisition</a>
                        </div>
                        <div class="col-12 py-1 text-center">
                            <a href="#calc-probability">Probability</a>
                        </div>
                        <div class="col-12 py-1 text-center">
                            <a href="#aoi-selection">AOI Selection</a>
                        </div>
                        <div class="col-12 py-1 text-center">
                            <a href="#pipeline-ideas">Getting Started</a>
                        </div>
                    </div>
                </div>

                <!-- simple demonstration of process -->
                <div class="d-flex justify-content-center">
                    <div id="start-form-div" class="col col-lg-9 col-xxl-9">

                        <div class="input-sections" id="how-it-works">
                            <h5>How it works:</h5>
                            <div class="row">

                                <div class="col-md-4 py-2 text-center ">
                                    <p>Choose your parameters</p>
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643132328/tokyo1_jyg3wc.jpg">
                                </div>

                                <div class="col-md-4 py-2 text-center">
                                    <p>Submit your pipeline</p>
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643351357/tokyo2_xggix2.jpg">

                                </div>

                                <div class="col-md-4 py-2 text-center">
                                    <p>View your images</p>
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643132650/tokyp3_k82g82.jpg">

                                </div>
                            </div>
                        </div>
                        <hr>

                        <div class="input-sections" id="restrictions">
                            <h5>Restrictions:</h5>
                            <h6>This service is free, therefore there are some strict parameter limits.</h6>
                            <ul>
                                <li>- The Area of Interest (AOI) must be more than 25 km<sup>2</sup>, and no more than
                                    10,000
                                    km<sup>2</sup></li>
                                <li>- Pipelines can have no more than 10 intervals</li>
                                <li>- Resolution is limited to 8 to 15 metres</li>
                                <li>- Only images taken within the last 3 years (since 2020) are available</li>
                            </ul>
                        </div>
                        <hr>

                        <div class="input-sections" id="satellite-aquisition">
                            <h5>Satellite aquisition:</h5>
                            <h6>We cannot guarantee that pipelines will deliver images, but see our recommendations for
                                the maximum chance of your pipeline delivering images</h6>
                            <ul>
                                <li>- Choose a larger AOI (up to 10,000 km<sup>2</sup>)<br><small>The larger the AOI,
                                        the
                                        more chance it falls within a satellite's trajectory</small></li>
                                <li>- Maximise the interval length<br><small>If the pipeline interval is a month, there
                                        is
                                        more
                                        chance
                                        a satellite is orbiting overhead at some point within those 30 days, than if the
                                        interval is
                                        set to 1 day</small></li>
                                <li>- Increase allowable cloud cover percentage<br><small>If allowable cloud cover
                                        percentage is
                                        set to a low number, it will reject any images above this number. (This does not
                                        mean all images
                                        will be below the number set.)</small></li>
                            </ul>
                        </div>
                        <hr>

                        <div class="input-sections" id="calc-probability">
                            <h5>Calculate Probability</h5>
                            <h6>We can calculate the probability of return of images on the pipeline parameters you
                                choose.
                            </h6>
                            <p>If the percentage probability is low, we will give you advice on how to increase it
                                before you commit your pipeline.</p>
                            <p>Probability calculation is only available for <strong>True Colour</strong> images.</p>
                        </div>
                        <hr>

                        <div class="input-sections" id="aoi-selection">
                            <h5>Selecting the AOI</h5>
                            <h6>Use the map to select an Area of Interest for your pipeline</h6>

                            <div class="row">
                                <div class="col-12 col-md-6 col-lg-4">
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114686/aoi1_bjsn9n.jpg">
                                    <p>Click on the map to start drawing points to form a polygon. Use the toolbar to toggle between Selecting and Deleting</p>
                                </div>

                                <div class="col-12 col-md-6 col-lg-4">
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114687/aoi3_nzuvlp.jpg">
                                    <p>Double click on an individual point to delete it, by clicking the trash icon or
                                        delete
                                        on the keyboard</p>
                                </div>

                                <div class="col-12 col-md-6 col-lg-4">
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114686/aoi4_g3syt0.jpg">
                                    <p>Any of the points can be dragged to change the shape of the polygon</p>
                                </div>

                                <div class="col-12 col-md-6 col-lg-4">
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643114686/aoi6_vk2qdp.jpg">
                                    <p>The polygon can be picked up and moved</p>
                                </div>

                                <div class="col-12 col-md-6 col-lg-4">
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643201669/aoi8_one1cw.jpg">
                                    <p>The first point selected must also be selected at the end to complete the polygon
                                        shape</p>
                                </div>

                                <div class="col-12 col-md-6 col-lg-4">
                                    <img style="width: 100%; height: 200px;"
                                        src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1644180206/aiintersection_o3r50y.jpg">
                                    <p>Maintain a complete shape, with no intersecting lines. The above AOI would result in an error</p>
                                </div>
                            </div>
                        </div>
                        <hr>

                        <div class="input-sections" id="pipeline-ideas">
                            <h5>Pipeline Ideas</h5>
                            <h6>Not sure how to begin? Here are some ideas to get you started..</h6>

                            <ul>
                                <li>Select an AOI of the area you used to live in, to see if the landscape has changed
                                </li>
                                <li>See if you can collect images from the Tonga volcano eruption on the 14<sup>th</sup>
                                    January 2022</li>
                                <li>Track Hurricane Ida in Louisiana, USA from August to September 2021</li>
                            </ul>

                        </div>
                    </div>
                </div>
            </div>

            <!-- general form section -->
            <div id="general_form_section" class="tab">
                
                <!-- section heading and intro -->
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>General</h4>
                            <br>
                            <p>Provide some general details to identify your pipeline</p>
                        </div>
                    </div>
                </div>

                <!-- form fields -->
                <div class="section_div">
                    <div class="input-sections" id="form_name_div">
                        <label for="pipeline_name" class="form-label">Name</label>
                        {{form.pipeline_name}}
                    </div>

                    <div class="input-sections" id="form-des-div">
                        <label for="pipeline_des" class="form-label">Description</label>
                        {{form.pipeline_des}}
                    </div>
                </div>
            </div>

            <!-- aoi form section -->
            <div id="aoi_form_section" class="tab">
                
                <!-- section heading and intro -->
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Area of Interest</h4>
                            <p>The Area of Interest (AOI) is the area on Earth of which you want to find images.</p>
                            <p>Tell us where to look for images. <span class="form_limits">Area must be between 25
                                    km<sup>2</sup> and 10,000 km<sup>2</sup></span></p>
                        </div>
                    </div>
                </div>

                <!-- AOI size and validation feedback -->
                <div id="map-feedback">
                    <p id="map-area">Area: 0 km<sup>2</sup></p>
                </div>

                <!-- mapbox map -->
                <div id="create-map"></div>

                <!-- hidden form field -->
                <div class="input-sections">
                    {{form.aoi}}
                </div>
            </div>

            <!-- interval form section -->
            <div id="interval_form_section" class="tab">

                <!-- section heading and intro -->
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Interval</h4>
                            <br>
                            <p>Select the start and end date of this pipeline and how frequently to search for images
                                <br>
                                The pipeline will aim to deliver one image between each interval start and end date</p>
                            <p>Intervals in the past will search for archived imagery and, if available, deliver them
                                straight away.<br>Future intervals will be set up to deliver images as soon as an image
                                in that interval is found.</p>
                            <p class="form_limits">Pipelines can not be <em>set up</em> to have more than 10 intervals,
                                but depending on the layout of dates, our system may deliver more than 10 results</p>
                        </div>
                    </div>

                    <!-- <div class="col d-flex justify-content-end">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div> -->
                </div>

                <!-- form fields -->
                <div class="row">
                    <div class="col-md-4" id="s_date">
                        <label for="start_date" class="form-label">from</label>
                        {{form.start_date}}
                    </div>

                    <div class="col-md-4" id="e_date">
                        <label for="end_date" class="form-label">to</label>
                        {{form.end_date}}
                    </div>
                </div>

                <div class="input-sections w-50 w-md-25">
                    <label for="interval" class="form-label">Interval</label>
                    {{form.interval}}
                </div>
            </div>

            <!-- parameters form section -->
            <div id="parameters_form_section" class="tab">

                <!-- section heading and intro -->
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Parameters</h4>
                        </div>
                    </div>
                </div>

                <!-- form field and description -->
                <div class="input-sections">
                    <label for="cloud_cover" class="form-label">Cloud cover</label>
                    <p><strong>Minimum</strong> cloud free area (% of your AOI) your image results must have.<br>
                        <p>If this is set to 100%, you want your pipeline to have 100% cloud free area (100% AOI
                            visible).<br> The higher this parameter, the lower chance of receiving images as the
                            platform
                            will reject images below this number.</p>
                    </p>
                    {{form.cloud_cover}}
                </div>

                <!-- images to represent cloud cover -->
                <div class="input-sections" id="cloud-cover">
                    <div class="row">
                        <div class="col-sm-4 p-3">
                            <img
                                src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642782571/30-per-cloud-cover_vfgigm.jpg">
                            <br>
                            <p><strong>Low cloud cover (high cloud free area)</strong></p>
                            <p>High AOI coverage</p>
                            <p>Lower probability of image return</p>
                        </div>

                        <div class="col-sm-4 p-3">
                            <img
                                src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642782570/65-per-cloud-cover_ufppk0.jpg">
                            <br>
                            <p><strong>Medium cloud cover (medium cloud free area)</strong></p>
                            <p>Medium AOI coverage</p>
                            <p>Medium probability of image return</p>
                        </div>

                        <div class="col-sm-4 p-3">
                            <img
                                src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642782571/80-per-cloud-cover_j3wok7.jpg">
                            <br>
                            <p><strong>High cloud cover (low cloud free area)</strong></p>
                            <p>Low AOI coverage</p>
                            <p>Higher probability of image return</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- output image form section -->
            <div id="output_form_section" class="tab">

                <!-- section heading and intro -->
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Output Type</h4>
                            <br>
                            <p>Select the desired output image type</p>
                            <p class="form_limits">Only choosing a <em>True Color</em> image will allow for calculation
                                of
                                aquisition probability</p>
                        </div>
                    </div>

                    <!-- <div class="col d-flex justify-content-end">
                        <a><button class="btn btn-secondary">Save Progress</button></a>
                    </div> -->
                </div>

                <!-- 1st row: render output fields as selectable pictures/radio buttons -->
                <!-- the image description (class="image-des") are taken from the Skywatch EarthCache concole -->
                <div class="row">
                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">True Colour</p>
                            {{form.output_image.1.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642749757/true-colour_b02a5f.jpg">
                                <div class="image-des">
                                    <p>A true colour image is a combination of red, green, and blue bands. The results
                                        have been pansharpened where possible.</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">False Colour Urban</p>
                            {{form.output_image.2.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642749875/false-colour-urban_mifri2.jpg">
                                <div class="image-des">
                                    <p>A false colour urban composite image is a combination of short wave infrared 1
                                        (SWIR1), short wave infrared 2 (SWIR2), and red bands. It is often used to track
                                        urban sprawl and identify areas at risk of flooding.</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">False Colour Infrared</p>
                            {{form.output_image.3.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1642749876/false-colour-infrared_vc3jjh.png">
                                <div class="image-des">
                                    <p>A false colour infrared composite image is a combination of near-infrared, red,
                                        and green bands. It is often used to track vegetation health or help identify
                                        different types of soil and minerals.</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 2nd row: render output fields as selectable pictures/radio buttons -->
                <div class="row">
                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">All Optical Bands</p>
                            {{form.output_image.4.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643284152/allbands-img_n2sfpo.jpg">
                                <div class="image-des">
                                    <p>All optical spectral bands in a product</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">MSAVI2</p>
                            {{form.output_image.5.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643284152/msavi2-image_uspufz.jpg">
                                <div class="image-des">
                                    <p>MSAVI2 images are often used to look at vegetation cover, biomass and to
                                        determine leaf area index. They can also be used as an input layer for mapping
                                        land cover or vegetation classes</p>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="col-sm-4 py-1">
                        <label class="output-label">
                            <p class="image-label">Near Infrared</p>
                            {{form.output_image.6.tag}}
                            <div class="image-parent">
                                <img class="image-image"
                                    src="https://res.cloudinary.com/code-institute-mojos-beans/image/upload/v1643284152/nearingrared-img_n2w1my.jpg">
                                <div class="image-des">
                                    <p>This will return the near-infrared (NIR) values for your area of interest.</p>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

            </div>

            <!-- review form section -->
            <div id="review_form_section" style="height: auto;" class="tab">
               
                <!-- section heading and intro -->
                <div class="row">
                    <div class="col">
                        <div class="form_title">
                            <h4>Review</h4>
                            <br>
                            <p>Congratulations on setting up your pipeline. <br>
                                Please review the pipeline parameters and ensure they are correct before submitting</p>
                            <p class="form_limits">*parameters which can be changed after pipeline is committed</p>
                        </div>
                    </div>
                </div>

                <!-- feedback information from user's form -->
                <table id="feedback-table">
                    <tr>
                        <td class="table-section" colspan="2">General Information</td>
                    </tr>
                    <tr>
                        <td class="table-left">*Pipeline name:</td>
                        <td id="table-name" class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-left">*Description:</td>
                        <td id="table-des" class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-left">Status:</td>
                        <td class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-section" colspan="2">Interval</td>
                    </tr>
                    <tr>
                        <td class="table-left">Starts:</td>
                        <td id="table-sdate" class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-left">Ends:</td>
                        <td id="table-edate" class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-left">Length:</td>
                        <td id="table-length" class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-left">Interval:</td>
                        <td id="table-interval" class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-left">Number of intervals:</td>
                        <td id="table-num-interval" class="table-right"></td>
                    </tr>
                    <tr>
                        <td class="table-section" colspan="2">Output</td>
                    </tr>
                    <tr>
                        <td class="table-left">Output:</td>
                        <td id="table-output" class="table-right"></td>
                    </tr>
                </table>

                <!-- mapbox map -->
                <div id="review-aoi"></div>

                <!-- AOI info feedback -->
                <table id="feedback-aoi">
                    <tr>
                        <td class="table-section" colspan="2">Area of Interest</td>
                    </tr>
                    <tr>
                        <td class="table-left">Area:</td>
                        <td class="table-right" id="table-area"></td>
                    </tr>
                    <tr>
                        <td class="table-left">geoJSON:</td>
                        <td class="table-right"><textarea id="table-geojson" rows="8" cols="15" disabled></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td class="table-left">Minimum cloud free area:</td>
                        <td class="table-right" id="table-cloud"></td>
                    </tr>
                </table>
                <hr>

                <!-- prompt about submitting -->
                <div style="text-align:center; margin-top: 60px; margin-bottom: 60px;">
                    <h4>Ready to submit?</h4><br>
                    <h5>Once submitted, you will be redirected to your new pipeline.</h5>
                    <h5>Processing pipelines can take a few minutes, so you will be encouraged to update the pipeline
                        after a few minutes
                    </h5>
                </div>
            </div>

            <!-- pipeline submitted section -->
            <div id="submitting_pipeline" class="tab">
                <h2>Thank you for submitting your pipeline.</h2>
                <h5 id="submitting_name"></h5>
                <p>Please do not refresh your browser while we do this.</p>
                <div class="loader"></div>
            </div>

            <!-- buttons and progress display section -->
            <div id="buttons-div">
                <div class="row align-items-center">
                    <div class="py-2 col-sm-4 order-sm-first d-flex justify-content-center justify-content-sm-start">
                        <button type="button" class="btn btn-dark" id="prevButton"
                            onclick="nextPrev(-1)">Previous</button>
                    </div>

                    <div class="py-2 order-last col-sm-4 d-flex justify-content-center">
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>

                    </div>

                    <div
                        class="py-2 order-first order-sm-last col-sm-4 d-flex justify-content-center justify-content-sm-end">
                        <button type="button" class="btn btn-dark" id="nextButton" onclick="nextPrev(1)">Next</button>
                    </div>
                </div>
            </div>
        </form>

        <!-- ensure only authenticated users can access this page -->
        {% else %}
        <p style="margin-top: 150px;">You are not permitted to create a pipeline without being logged in.
            Sign up <a href="{% url 'account_login' %}">here</a>
        </p>
        {% endif %}
    </div>
</body>

<script>

    // highlight the 'Create' page in the nav bar
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('nav-active-page')) {
            document.getElementById('nav-active-page').removeAttribute('nav-active-page')
        }
        document.getElementsByClassName('nav-link')[2].setAttribute("id", "nav-active-page")

        currentTab = 0;
    });

    // set the default output image
    document.getElementById('id_output_1').checked = true;

    // set the variables
    var currentTab = 0;
    var mapLoads = true
    showTab(currentTab)
    var interval;
    var mapbox_key = "{{ mapbox_key | safe}}";

    /**
    Parse dates into correct format and
    ensure the interval dates are valid
    */
    function validateDate() {

        // if feedback already exists, remove it
        if (document.getElementById('interval_feedback')) {
            document.getElementById('interval_feedback').remove()
        }

        // what am I doing here, I have no idea
        if (document.getElementById('nextButton').disabled = true) {
            document.getElementById('nextButton').disabled = false;
        };

        if (document.getElementById('prevButton').disabled = true) {
            document.getElementById('prevButton').disabled = false;
        };

        // create new div to display interval feedback/validation
        interval_append = document.getElementById('interval_form_section');
        interval_feedback = document.createElement('div');
        interval_append.append(interval_feedback);
        interval_feedback.id = 'interval_feedback';

        // get user's dates input
        start_date = document.getElementById('start_date').value;
        end_date = document.getElementById('end_date').value;

        // get user's interval choice
        interval = document.getElementById('interval').value;
        interval_num = interval.slice(0, interval.length - 1);

        // parse into JS date format
        day1 = parseInt(start_date.slice(8, 10));
        day2 = parseInt(end_date.slice(8, 10));
        month1 = parseInt(start_date.slice(5, 7));
        month2 = parseInt(end_date.slice(5, 7));
        year1 = parseInt(start_date.slice(0, 4));
        year2 = parseInt(end_date.slice(0, 4));
        s_date = (month1 + '/' + day1 + '/' + year1);
        e_date = (month2 + '/' + day2 + '/' + year2);

        date1 = new Date(s_date);
        date2 = new Date(e_date);

        // calculate day difference
        var time_difference = date2.getTime() - date1.getTime();
        days_difference = Math.round(time_difference / (1000 * 60 * 60 * 24));
        num_intervals = days_difference / interval_num;
        num_intervals_rounded = Math.round(num_intervals)

        // display how many days the pipeline length is
        if (end_date && start_date && interval) {
            pipeline_length = document.createElement('p');
            pipeline_length.id = 'pipeline_length';
            pipeline_length.innerHTML = `Pipeline length: ${days_difference} days`;
            interval_feedback.append(pipeline_length);

            pipeline_intervals = document.createElement('p');
            pipeline_intervals.id = 'pipeline_intervals';
            pipeline_intervals.innerHTML =
                `Number of intervals: ${num_intervals_rounded}<br><small>this may change based on the layout of the intervals`;
            interval_feedback.append(pipeline_intervals);
        }

        // date error if start date is after end date
        if (end_date <= start_date && end_date) {
            date_error = document.createElement('p');
            date_error.innerHTML =
                "<small>The end date cannot be before the start date: <br> select a date after start date </small>";
            date_error.style.fontWeight = 'bold';
            interval_feedback.append(date_error);
            document.getElementById('nextButton').disabled = true;
            document.getElementById('prevButton').disabled = true;
            document.getElementById('pipeline_intervals').innerHTML = ""
            document.getElementById('pipeline_length').innerHTML = ""
        }

        // if num of intervals is more than 10 (API restriction for free data)
        if (num_intervals > 10 && end_date && start_date && interval) {
            interval_error = document.createElement('p');
            interval_error.innerHTML =
                "<small>Pipelines cannot have more than 10 intervals: <br> choose a larger interval // decrease the pipeline length</small>";
            interval_error.style.fontWeight = 'bold';
            interval_feedback.append(interval_error);
            document.getElementById('nextButton').disabled = true;
            document.getElementById('prevButton').disabled = true;
            document.getElementById('pipeline_length').innerHTML = ""
        }

        // if interval is larger than pipeline
        if (interval_num > days_difference && end_date && start_date && interval) {
            interval_error = document.createElement('p');
            interval_error.innerHTML =
                '<small>The interval cannot be larger than the pipeline length: <br> choose a smaller interval // increase the pipeline length<small>';
            interval_error.style.fontWeight = 'bold';
            interval_feedback.append(interval_error);
            document.getElementById('nextButton').disabled = true;
            document.getElementById('prevButton').disabled = true;
            document.getElementById('pipeline_length').innerHTML = ""
        }

        // if date is too far in the past
        if (year1 < 2020 || year2 < 2020) {
            interval_error = document.createElement('p');
            interval_error.innerHTML =
                '<small>We cannot look for images before 2020: <br> choose a more recent date<small>';
            interval_error.style.fontWeight = 'bold';
            interval_feedback.append(interval_error);
            document.getElementById('nextButton').disabled = true;
            document.getElementById('prevButton').disabled = true;
            document.getElementById('pipeline_intervals').innerHTML = ""
            document.getElementById('pipeline_length').innerHTML = ""
        }

    }

    /**
    Apply 'checked' style to selected output image
    */
    function styleOutputImage() {

        parent_checked = document.getElementsByClassName('output-label')

        for (i = 0; i < parent_checked.length; i++) {

            if (parent_checked[i].childNodes[3].checked) {
                parent_checked[i].style.fontWeight = 'bold';
                parent_checked[i].childNodes[5].style.opacity = '0.6';
            } else {
                parent_checked[i].style.fontWeight = 'normal';
                parent_checked[i].childNodes[5].style.opacity = '1';
            }
        }
    }

    /**
    External library with adjustments
    W3S https://www.w3schools.com/howto/howto_js_form_steps.asp 
    */
    function showTab(num) {
        var tab = document.getElementsByClassName('tab');
        tab[num].style.display = 'block';

        if (num == 0) {
            document.getElementById('prevButton').style.display = 'none';

        } else if (num == 1) {
            document.getElementById("prevButton").style.display = "inline";

        } else if (num == 2) {

            if (document.getElementById('id_aoi').value != "null") {

            } else {
                createMap();
            }

        } else if (num == 4) {

            reviewMap();

        } else if (num == 5) {

            styleOutputImage();

        } else if (num == 6) {

            createReview();

        } else if (num == 7) {
            document.getElementById("buttons-div").style.display = "none";
        }

        if (num == (tab.length - 2)) {
            document.getElementById('nextButton').innerHTML = "Submit";

        } else if (num == (tab.length - 3)) {
            document.getElementById('nextButton').innerHTML = "Review";

        } else {
            document.getElementById('nextButton').innerHTML = "Next";
        }

        fixStepIndicator(num)
    }

    /**
    External library with adjustments
    W3S https://www.w3schools.com/howto/howto_js_form_steps.asp 
    */
    function nextPrev(num) {

        console.log(currentTab)
        var x = document.getElementsByClassName('tab');
        if (num == 1 && !validateForm()) return false;
        x[currentTab].style.display = 'none';
        currentTab = currentTab + num;

        if (x.length - currentTab == 1) {
            document.getElementById('submitting_pipeline').style.display = 'block';
            document.getElementById('buttons-div').style.display = "none";
            document.getElementById('submitting_name').innerHTML =
                `We are setting up "${document.getElementById('pipeline_name').value}"..`
            document.getElementById('create_form').submit();
            return false;
        }

        showTab(currentTab);
    }

    /**
    External library with adjustments
    W3S https://www.w3schools.com/howto/howto_js_form_steps.asp 
    */
    function fixStepIndicator(num) {

        var i, x = document.getElementsByClassName("step");
        for (i = 0; i < x.length - 1; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }

        x[num].className += " active";
    }

    /**
    External library with adjustments
    W3S https://www.w3schools.com/howto/howto_js_form_steps.asp 
    */
    function validateForm() {

        var x, y, i, valid = true;
        x = document.getElementsByClassName("tab");
        y = x[currentTab].getElementsByTagName("input");

        for (i = 0; i < y.length; i++) {

            if (y[i].value == "") {
                y[i].className += " invalid";
                valid = false;
            }

            if (y[i].checked) {
                valid = true;
            }
        }

        if (valid) {
            document.getElementsByClassName("step")[currentTab].className += " finish";
        }
        return valid;
    }

    /**
    Call the Mapbox API to display a map
    which the user can draw onto
    Validate the AOI area 
    External library with adjustments
    Mapbox https://docs.mapbox.com/mapbox-gl-js/example/mapbox-gl-draw/
    */
    function createMap() {

        input_validation = document.getElementById('id_aoi');

        // create the map
        mapboxgl.accessToken = mapbox_key;
        const map = new mapboxgl.Map({
            container: 'create-map',
            style: 'mapbox://styles/mapbox/streets-v11',
            zoom: 4,
        });

        // create the draw function
        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {
                polygon: true,
                trash: true
            },
            defaultMode: 'draw_polygon'
        });
        map.addControl(draw);

        // call function based on user actions on map
        map.on('draw.create', updateArea);
        map.on('draw.delete', deleteArea);
        map.on('draw.update', updateArea);

        aoi_section = document.getElementById('map-feedback')

        function updateArea(e) {

            // remove this parameter to be replaced on re-draw
            if (document.getElementById('map-a')) {
                (document.getElementById('map-a').remove())
            }

            input_validation = document.getElementById('id_aoi')

            // set or reset the map area to 0km
            map_area = document.getElementById('map-area')
            map_area.innerHTML = "Area: 0 km<sup>2</sup>"

            // get the drawn polygon data
            const data = draw.getAll();
            console.log(data['features'][0]['geometry']['coordinates'])

            // if feedback exists, delete it
            if (document.getElementById('area_validation_feedback')) {
                document.getElementById('area_validation_feedback').remove();
            }

            // if there is data drawn
            if (data.features.length > 0) {

                // disable the draw polygon to disallow 
                // more than 1 polygon
                document.getElementsByClassName('mapbox-gl-draw_ctrl-draw-btn')[0].disabled = true
                document.getElementsByClassName('mapbox-gl-draw_ctrl-draw-btn')[0].style.backgroundColor = "grey"

                // get the area of the data
                const area = turf.area(data);

                // determine if there are an intersecting points
                const poly = turf.polygon(data['features'][0]['geometry']['coordinates'])
                const kinks = turf.kinks(poly)
                console.log(kinks['features'].length)

                const rounded_area = Math.round(area * 100) / 100;
                rounded_km = (rounded_area / 1000000).toFixed(2);

                // create feedback to display to user
                area_validation_feedback = document.createElement('p')
                area_validation_feedback.id = "area_validation_feedback"

                map_a = document.createElement('p');
                map_a.id = 'map-a';
                map_a.style.display = "none";
                map_a.innerHTML = rounded_km;
                aoi_section.append(map_a)

                // if area is too large
                if (rounded_km > 10000) {
                    area_validation = "Area is too large: choose an area smaller than 10,000 km<sup>2</sup>";
                    area_validation_feedback.style.fontWeight = 'bold';
                    input_validation.value = "";

                // if area is too small    
                } else if (rounded_km < 25) {
                    area_validation = "Area is too small: choose an area larger than 25 km<sup>2</sup>";
                    area_validation_feedback.style.fontWeight = 'bold';
                    input_validation.value = "";

                // if there are intersecting lines
                } else if (kinks['features'].length > 0) {    
                    area_validation = "AOI selection is not valid: choose a complete area with no intersecting lines";
                    area_validation_feedback.style.fontWeight = 'bold';
                    input_validation.value = "";

                // if area size is valid
                } else {

                    // input the geoJSON into the form field
                    area_validation = "";
                    text = JSON.stringify(data);
                    input_validation.value = text;
                    document.getElementById('nextButton').disabled = false
                }

                // apply validation feedback to webpage
                map_area.innerHTML = `<p>Area: <strong>${rounded_km} km <sup>2</sup>`;
                area_validation_feedback.innerHTML = `${area_validation}`;
                aoi_section.append(area_validation_feedback);

            } else {
                if (e.type !== 'draw.delete')
                    alert('Click the map to draw a polygon.');
            }
        }

        // if polygon has been deleted, remove form field value
        function deleteArea() {
            input_validation.value = ""
            document.getElementsByClassName('mapbox-gl-draw_ctrl-draw-btn')[0].disabled = false
            document.getElementsByClassName('mapbox-gl-draw_ctrl-draw-btn')[0].style.backgroundColor = "white"
            area_validation = ""
            area_validation_feedback.innerHTML = `${area_validation}`;
            map_area.innerHTML = "Area: 0 km<sup>2</sup>"
            
        }

        // remove the null value and set to blank
        // to stop form progressing on default
        if (input_validation.value == 'null') {
            input_validation.value = "";
        }
    }

    /**
    Display a map to render the user's chosen AOI area
    */
    function reviewMap() {

        // get the geoJSON from the form and format it
        aoi_json = JSON.parse(document.getElementById('id_aoi').value);
        aoi_map = aoi_json['features'][0]['geometry'];

        // create long and lat to set the map center 
        long = turf.centerOfMass(aoi_map)['geometry']['coordinates'][0]
        lat = turf.centerOfMass(aoi_map)['geometry']['coordinates'][1]

        // MAPBOX code
        mapboxgl.accessToken =
            mapbox_key;
        const map = new mapboxgl.Map({
            container: 'review-aoi',
            style: 'mapbox://styles/mapbox/light-v10',
            center: [long, lat],
            zoom: 5,
        });

        map.on('load', () => {

            map.addSource('display_aoi', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'geometry': aoi_map,
                }
            });

            map.addLayer({
                'id': 'display_aoi',
                'type': 'fill',
                'source': 'display_aoi',
                'layout': {},
                'paint': {
                    'fill-color': '#0080ff',
                    'fill-opacity': 0.5
                }
            });

            map.addLayer({
                'id': 'outline',
                'type': 'line',
                'source': 'display_aoi',
                'layout': {},
                'paint': {
                    'line-color': '#000',
                    'line-width': 3
                }
            });
        });
    }

    /**
    Collect all user's form field values and
    display back to them for review
    */
    function createReview() {

        reviewMap();

        // get table cells to fill in 
        table_feedback = document.getElementsByClassName('table-right');

        // get user's form inputs
        review_name = document.getElementById('pipeline_name').value;
        review_des = document.getElementById('pipeline_des').value;
        review_status = "Not yet committed";
        review_aoi = document.getElementById('id_aoi').value;
        review_sdate = document.getElementById('start_date').value;
        review_edate = document.getElementById('end_date').value;
        review_length = `${days_difference} days`;
        review_interval = interval;
        review_num_intervals = num_intervals_rounded;
        review_area = `${document.getElementById('map-a').innerHTML} km<sup>2</sup>`;
        review_cloud = document.getElementById('id_cloud').value

        radios = document.getElementsByName('output_image');
        radios_labels = document.getElementsByClassName('image-label');

        // determine which output image has been selected
        for (i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                review_output = radios_labels[i].innerText.trim();
                api_output = radios[i].value
            }
        }

        // render user's form inputs into the review table
        feedback = [review_name, review_des, review_status, review_sdate, review_edate, review_length, review_interval,
            review_num_intervals, review_output
        ];

        for (i = 0; i < feedback.length; i++) {
            table_feedback[i].innerHTML = feedback[i];
        }

        document.getElementById('table-area').innerHTML = review_area;
        document.getElementById('table-geojson').innerHTML = review_aoi;
        document.getElementById('table-cloud').innerHTML = `${review_cloud}%`;
    }

    /**
    Validate that the cloud cover selected is
    between 1 and 100
    */
    function validateCloudCover() {

        cloud_input = document.getElementById('id_cloud').value

        if (cloud_input > 100 || cloud_input < 1) {
            document.getElementById('nextButton').disabled = true;
            document.getElementById('prevButton').disabled = true;
        } else {
            document.getElementById('nextButton').disabled = false;
            document.getElementById('prevButton').disabled = false;
        }
    }

    // for (i = 0; i < document.getElementsByClassName('tab').length - 1; i++) {
    //     document.getElementsByClassName('tab')[i].style.display = "none"
    // }

    // document.getElementsByClassName('tab')[7].style.display = "inline-block"
</script>

{% endblock content %}